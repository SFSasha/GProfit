<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Miner (HTML+JS)</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase SDK (Authentication –∏ Firestore) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –°–†–ï–î–´ CANVAS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- –ö–û–ù–°–¢–ê–ù–¢–´ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        const MINE_COOLDOWN_SECONDS = 60; // 60 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É "–≤–∑—Ä—ã–≤–∞–º–∏"
        const MINE_AMOUNT = 100; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ –∑–∞ –æ–¥–∏–Ω "–≤–∑—Ä—ã–≤"
        const WITHDRAW_MIN = 5000; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
        
        let db;
        let auth;
        let userId = null;
        let userStats = {
            stars: 0,
            lastMineTime: 0,
            referralCount: 0,
            referrerId: null
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.MainButton.setText('üöÄ –í–∑–æ—Ä–≤–∞—Ç—å –∞—Å—Ç–µ—Ä–æ–∏–¥');
        tg.MainButton.onClick(blast);

        // --- –°–°–´–õ–ö–ò –ù–ê –≠–õ–ï–ú–ï–ù–¢–´ UI ---
        const starsBalanceEl = document.getElementById('starsBalance');
        const cooldownTimerEl = document.getElementById('cooldownTimer');
        const blastButton = document.getElementById('blastButton');
        const referralCountEl = document.getElementById('referralCount');
        const referralLinkEl = document.getElementById('referralLink');
        const withdrawAmountInput = document.getElementById('withdrawAmount');
        const withdrawButton = document.getElementById('withdrawButton');
        const minWithdrawEl = document.getElementById('minWithdraw');

        // --- –£–¢–ò–õ–ò–¢–´ FIREBASE ---
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É—Ç–∏ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserDocRef(uid) {
            return doc(db, 
                `artifacts/${appId}/users/${uid}/miner_data/user_stats`, 
                'profile');
        }

        // --- –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ---

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firestore
                setLogLevel('debug');
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. UID:", userId);
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        setupUserListener(userId);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                        updateReferralLink(userId);
                        
                    } else {
                        console.error("No user signed in.");
                        tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                    }
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                tg.showAlert(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Firebase: ${error.message}`);
            }
        }

        // --- –õ–û–ì–ò–ö–ê –î–ê–ù–ù–´–• (Firestore) ---

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function setupUserListener(uid) {
            const userDocRef = getUserDocRef(uid);
            
            onSnapshot(userDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // –î–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã, –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    const data = docSnapshot.data();
                    userStats.stars = data.stars || 0;
                    userStats.lastMineTime = data.lastMineTime || 0;
                    userStats.referralCount = data.referralCount || 0;
                    userStats.referrerId = data.referrerId || null;
                    console.log("User data updated:", userStats);
                    
                } else {
                    // –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                    console.log("User profile not found. Creating new one.");
                    createNewUser(uid);
                }
                updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è/—Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            }, (error) => {
                console.error("Firestore listen error:", error);
                tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            });
        }
        
        // –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function createNewUser(uid) {
            const userDocRef = getUserDocRef(uid);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ initDataUnsafe –ø–∞—Ä–∞–º–µ—Ç—Ä —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
            let referrerId = null;
            if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
                // start_param –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                const potentialReferrer = tg.initDataUnsafe.start_param;
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –Ω–µ —Ä–∞–≤–µ–Ω —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                if (potentialReferrer && potentialReferrer !== uid) {
                    referrerId = potentialReferrer;
                    processReferral(referrerId, uid);
                }
            }

            const initialData = {
                stars: 0,
                lastMineTime: 0,
                referralCount: 0,
                referrerId: referrerId,
                telegramId: tg.initDataUnsafe.user?.id || 'unknown'
            };
            
            setDoc(userDocRef, initialData).catch(error => {
                console.error("Error creating user profile:", error);
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —É –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function processReferral(referrerId, newUserId) {
             const referrerDocRef = getUserDocRef(referrerId);
             try {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                const referrerDoc = await getDoc(referrerDocRef);
                if (referrerDoc.exists() && referrerDoc.data().telegramId !== tg.initDataUnsafe.user?.id) {
                    const currentCount = referrerDoc.data().referralCount || 0;
                    await setDoc(referrerDocRef, { referralCount: currentCount + 1 }, { merge: true });
                    console.log(`Referral processed for ${referrerId}`);
                }
             } catch (error) {
                 console.warn("Failed to process referral:", error);
             }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (Blast) ---

        // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è "–í–∑–æ—Ä–≤–∞—Ç—å –∞—Å—Ç–µ—Ä–æ–∏–¥"
        async function blast() {
            if (!userId) {
                 tg.showAlert('‚ùå –û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.');
                 return;
            }
            
            const currentTime = Date.now() / 1000;
            const timeSinceLastMine = currentTime - userStats.lastMineTime;

            if (timeSinceLastMine < MINE_COOLDOWN_SECONDS) {
                tg.showAlert(`üöÄ –û–∂–∏–¥–∞–π—Ç–µ: –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∑—Ä—ã–≤–∞ –æ—Å—Ç–∞–ª–æ—Å—å ${Math.ceil(MINE_COOLDOWN_SECONDS - timeSinceLastMine)} —Å–µ–∫.`);
                return;
            }
            
            // –í–∫–ª—é—á–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            tg.MainButton.showProgress(true);
            
            const userDocRef = getUserDocRef(userId);

            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firestore: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–≤–µ–∑–¥—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                await setDoc(userDocRef, {
                    stars: userStats.stars + MINE_AMOUNT,
                    lastMineTime: currentTime
                }, { merge: true });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–≤–µ–∑–¥
                showFloatingText(`+${MINE_AMOUNT} ‚ú®`);
                tg.showAlert(`üéâ –£—Å–ø–µ—Ö! –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${MINE_AMOUNT} –∑–≤–µ–∑–¥.`);
                
            } catch (error) {
                console.error("Error updating user stats:", error);
                tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ "–≤–∑—Ä—ã–≤–∞": ${error.message}`);
            } finally {
                // –í—ã–∫–ª—é—á–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (UI –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ onSnapshot)
                tg.MainButton.showProgress(false);
            }
        }

        // --- –õ–û–ì–ò–ö–ê –í–´–í–û–î–ê –°–†–ï–î–°–¢–í (Withdrawal) ---

        async function withdraw() {
            if (!userId) {
                 tg.showAlert('‚ùå –û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.');
                 return;
            }

            const amountStr = withdrawAmountInput.value.trim();
            const amount = parseInt(amountStr, 10);

            if (isNaN(amount) || amount <= 0) {
                tg.showAlert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ã–≤–æ–¥–∞.');
                return;
            }

            if (amount < WITHDRAW_MIN) {
                tg.showAlert(`‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: ${WITHDRAW_MIN} –∑–≤–µ–∑–¥.`);
                return;
            }

            if (amount > userStats.stars) {
                tg.showAlert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.');
                return;
            }

            tg.showConfirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–≤–æ–¥ ${amount} –∑–≤–µ–∑–¥.`, async (isConfirmed) => {
                if (!isConfirmed) return;

                tg.showProgress(true);
                const userDocRef = getUserDocRef(userId);

                try {
                    // 1. –°–ø–∏—Å—ã–≤–∞–µ–º –∑–≤–µ–∑–¥—ã —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await setDoc(userDocRef, {
                        stars: userStats.stars - amount,
                    }, { merge: true });

                    // 2. –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥ –≤ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    const withdrawalsCollectionRef = collection(db, 
                        `artifacts/${appId}/public/data/withdrawals`);
                        
                    await addDoc(withdrawalsCollectionRef, {
                        userId: userId,
                        telegramId: tg.initDataUnsafe.user?.id || 'unknown',
                        username: tg.initDataUnsafe.user?.username || 'N/A',
                        amount: amount,
                        status: 'pending', // –°—Ç–∞—Ç—É—Å –¥–ª—è "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
                        timestamp: serverTimestamp()
                    });

                    tg.showAlert('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                    withdrawAmountInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
                } catch (error) {
                    console.error("Withdrawal error:", error);
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–∞–Ω–Ω—ã–µ –∑–≤–µ–∑–¥—ã
                    // –ù–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    // –ó–¥–µ—Å—å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ.
                    tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
                } finally {
                    tg.showProgress(false);
                }
            });
        }
        
        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï UI –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï ---

        function updateUI() {
            // 1. –ë–∞–ª–∞–Ω—Å
            starsBalanceEl.textContent = userStats.stars.toLocaleString('ru-RU');
            minWithdrawEl.textContent = WITHDRAW_MIN.toLocaleString('ru-RU');

            // 2. –¢–∞–π–º–µ—Ä –∏ –∫–Ω–æ–ø–∫–∞ Blast
            const currentTime = Date.now() / 1000;
            const timeSinceLastMine = currentTime - userStats.lastMineTime;
            const remainingTime = MINE_COOLDOWN_SECONDS - timeSinceLastMine;
            
            // –û—Ç–∫–ª—é—á–∞–µ–º MainButton, –ø–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (userId === null) {
                tg.MainButton.hide();
                return;
            } else {
                 tg.MainButton.show();
            }

            if (remainingTime > 0) {
                const seconds = Math.ceil(remainingTime);
                cooldownTimerEl.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${seconds} —Å–µ–∫.`;
                blastButton.disabled = true;
                tg.MainButton.setParams({
                    text: `‚è≥ –û–∂–∏–¥–∞–µ–º ${seconds} —Å–µ–∫.`,
                    color: 'var(--tg-hint)'
                });
                
            } else {
                cooldownTimerEl.textContent = '–ì–æ—Ç–æ–≤ –∫ –≤–∑—Ä—ã–≤—É!';
                blastButton.disabled = false;
                tg.MainButton.setParams({
                    text: `üöÄ –í–∑–æ—Ä–≤–∞—Ç—å –∞—Å—Ç–µ—Ä–æ–∏–¥ (+${MINE_AMOUNT})`,
                    color: 'var(--tg-button)'
                });
            }
            
            // 3. –†–µ—Ñ–µ—Ä–∞–ª—ã
            referralCountEl.textContent = userStats.referralCount.toLocaleString('ru-RU');

            // 4. –ö–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞
            const amount = parseInt(withdrawAmountInput.value, 10);
            const isWithdrawValid = !isNaN(amount) && amount >= WITHDRAW_MIN && amount <= userStats.stars;
            withdrawButton.disabled = !isWithdrawValid;
            
            // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤—ã–≤–æ–¥–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞, Telegram MainButton –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            if (remainingTime > 0) {
                 tg.MainButton.disable();
            } else {
                 tg.MainButton.enable();
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
        setInterval(updateUI, 1000);

        // --- –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò UI ---

        function copyReferralLink() {
            // –í WebApp —Å—Å—ã–ª–∫—É –Ω—É–∂–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å —É—á–µ—Ç–æ–º initData
            const botUsername = "YOUR_BOT_USERNAME"; // –í—Å—Ç–∞–≤—å—Ç–µ –∏–º—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
            const link = `https://t.me/${botUsername}?start=${userId}`;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º document.execCommand('copy') –¥–ª—è iFrame —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            tg.showPopup({
                title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ',
                message: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.',
                buttons: [{ text: 'OK', type: 'default' }]
            });
        }
        
        function updateReferralLink(uid) {
            const botUsername = "YOUR_BOT_USERNAME"; // <-- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
            // –í WebApp —Å—Å—ã–ª–∫—É –Ω—É–∂–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å —É—á–µ—Ç–æ–º initData
            referralLinkEl.textContent = `https://t.me/${botUsername}?start=${uid}`;
        }
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∑–≤–µ–∑–¥
        function showFloatingText(text) {
            const floatingText = document.createElement('div');
            floatingText.textContent = text;
            floatingText.className = 'floating-text';
            document.body.appendChild(floatingText);

            setTimeout(() => {
                floatingText.remove();
            }, 1500);
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        document.addEventListener('DOMContentLoaded', () => {
             initFirebase();
             
             // –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–Ω–æ–ø–æ–∫
             blastButton.addEventListener('click', blast);
             document.getElementById('copyReferralButton').addEventListener('click', copyReferralLink);
             withdrawButton.addEventListener('click', withdraw);
             withdrawAmountInput.addEventListener('input', updateUI); // –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
             
             // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É –≤—ã–≤–æ–¥–∞
             document.getElementById('minWithdrawValue').textContent = WITHDRAW_MIN.toLocaleString('ru-RU');
        });


    </script>
    
    <style>
        /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Telegram --- */
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ TWA */
            --tg-bg: var(--tg-theme-bg-color, #18222d);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #91a8c0);
            --tg-link: var(--tg-theme-link-color, #65b8ff);
            --tg-button: var(--tg-theme-button-color, #5288c1);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #232e3c);
            
            /* –°—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ */
            --gold-color-light: #ffd700;
            --gold-color-dark: #ffb300;
            --gold-gradient: linear-gradient(145deg, var(--gold-color-light), var(--gold-color-dark));
            --dynamite-color: #e74c3c;
            --success-green: #2ecc71;
            
            --padding-base: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0;
            padding: var(--padding-base);
            padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è MainButton */
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* --- –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã --- */

        .card {
            background-color: var(--tg-secondary-bg);
            padding: var(--padding-base);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        h2 {
            font-size: 1.25rem;
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--tg-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hint {
            color: var(--tg-hint);
            font-size: 0.8rem;
        }
        
        /* --- –ë–ª–æ–∫ –ë–∞–ª–∞–Ω—Å–∞ --- */
        .balance-card {
            text-align: center;
            padding: 24px;
        }
        
        .balance-card .balance-value {
            font-size: 3rem;
            font-weight: 700;
            background-image: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            line-height: 1;
        }

        .balance-card .balance-label {
            font-size: 1rem;
            color: var(--tg-hint);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* --- –ë–ª–æ–∫ –ú–∞–π–Ω–∏–Ω–≥–∞/Blast --- */
        .blast-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .blast-button {
            width: 100%;
            padding: 16px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--tg-button-text);
            background-color: var(--dynamite-color);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.3s, background-color 0.3s;
            box-shadow: 0 4px 0px #b5382a;
            user-select: none;
        }
        
        .blast-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0px #b5382a;
        }

        .blast-button:disabled {
            background-color: var(--tg-hint);
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }
        
        /* --- –ë–ª–æ–∫ –†–µ—Ñ–µ—Ä–∞–ª–æ–≤ --- */
        .referral-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .referral-link-container {
            display: flex;
            gap: 10px;
        }
        
        #referralLink {
            background-color: var(--tg-bg);
            padding: 8px 12px;
            border-radius: 8px;
            flex-grow: 1;
            font-size: 0.9rem;
            word-break: break-all;
            color: var(--tg-link);
        }
        
        #copyReferralButton {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        
        /* --- –ë–ª–æ–∫ –í—ã–≤–æ–¥–∞ --- */
        .withdraw-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .withdraw-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #withdrawAmount {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            border: 1px solid var(--tg-secondary-bg);
            padding: 10px;
            border-radius: 8px;
            flex-grow: 1;
            font-size: 1rem;
            appearance: none;
        }
        
        #withdrawButton {
            background-color: var(--gold-color-dark);
            color: var(--tg-button-text);
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        #withdrawButton:disabled {
            background-color: var(--tg-hint);
            cursor: not-allowed;
        }
        
        /* --- –ê–Ω–∏–º–∞—Ü–∏—è –ø–ª–∞–≤–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ --- */
        .floating-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: var(--success-green);
            opacity: 0;
            animation: floatUp 1.5s ease-out;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes floatUp {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -100px); opacity: 0; }
        }
        
    </style>
</head>
<body>
    <div class="container">
        
        <!-- 1. –ë–ª–æ–∫ –ë–∞–ª–∞–Ω—Å–∞ -->
        <div class="card balance-card">
            <div class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-value">
                <span id="starsBalance">0</span> ‚ú®
            </div>
        </div>

        <!-- 2. –ë–ª–æ–∫ –ú–∞–π–Ω–∏–Ω–≥–∞ (Blast) -->
        <div class="card blast-area">
            <h2><span style="color: var(--dynamite-color);">üß®</span> –í–∑—Ä—ã–≤ –ê—Å—Ç–µ—Ä–æ–∏–¥–∞</h2>
            <div class="hint" id="cooldownTimer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            
            <button class="blast-button" id="blastButton" disabled>
                –í–∑–æ—Ä–≤–∞—Ç—å (+100)
            </button>
            
            <div class="hint">–ö–∞–∂–¥—ã–π –≤–∑—Ä—ã–≤ –¥–∞–µ—Ç 100 –∑–≤–µ–∑–¥. –ö—É–ª–¥–∞—É–Ω: 60 —Å–µ–∫—É–Ω–¥.</div>
        </div>

        <!-- 3. –ë–ª–æ–∫ –†–µ—Ñ–µ—Ä–∞–ª–æ–≤ -->
        <div class="card">
            <h2><span style="color: var(--tg-link);">üîó</span> –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ü—Ä–æ–≥—Ä–∞–º–º–∞</h2>
            
            <div class="referral-info">
                <span>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –¥—Ä—É–∑–µ–π:</span>
                <span id="referralCount" style="font-weight: 600;">0</span>
            </div>
            
            <div class="hint" style="margin-bottom: 10px;">
                –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π, —á—Ç–æ–±—ã –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π.
            </div>

            <div class="referral-link-container">
                <div id="referralLink">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button id="copyReferralButton">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <!-- 4. –ë–ª–æ–∫ –í—ã–≤–æ–¥–∞ -->
        <div class="card">
            <h2><span style="color: var(--gold-color-light);">üí∞</span> –í—ã–≤–æ–¥ –°—Ä–µ–¥—Å—Ç–≤</h2>
            
            <p class="hint">
                –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: <span id="minWithdrawValue">0</span> –∑–≤–µ–∑–¥.
            </p>

            <div class="withdraw-form">
                <div class="withdraw-input-group">
                    <input type="number" id="withdrawAmount" placeholder="–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞">
                    <span style="font-size: 1.5rem;">‚ú®</span>
                </div>
                
                <button id="withdrawButton" disabled>
                    –í—ã–≤–µ—Å—Ç–∏
                </button>
            </div>
            
        </div>
        
        <div class="hint" style="text-align: center; margin-top: 20px;">
            –í–∞—à ID –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏: <span id="userIdDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>

    </div>
</body>
</html>
