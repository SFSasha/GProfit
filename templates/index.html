<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Miner App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Telegram --- */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #18222d);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #91a8c0);
            --tg-link: var(--tg-theme-link-color, #65b8ff);
            --tg-button: var(--tg-theme-button-color, #5288c1);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #232e3c);
            
            /* –ó–æ–ª–æ—Ç—ã–µ —Å—Ç–∏–ª–∏ */
            --gold-color-light: #ffd700;
            --gold-color-dark: #ffb300;
            --gold-gradient: linear-gradient(145deg, var(--gold-color-light), var(--gold-color-dark));
            --dynamite-color: #e74c3c;
            --dynamite-gradient: linear-gradient(145deg, #ff6b6b, var(--dynamite-color));
            
            /* –ù–æ–≤—ã–π –∑–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ */
            --green-highlight: #2ecc71; /* –Ø—Ä–∫–∏–π –∑–µ–ª–µ–Ω—ã–π */
            --green-shadow: #27ae60;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        /* --- –û–±—â–∏–π –º–∞–∫–µ—Ç --- */
        .container {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 70px; 
        }

        /* --- –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –±–ª–æ–∫–∏ (–£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥) --- */
        .card {
            background-color: var(--tg-secondary-bg);
            border-radius: 16px; /* –ë–æ–ª–µ–µ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* –ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∞—è —Ç–µ–Ω—å */
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .balance-info {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item h3 {
            margin: 0;
            font-size: 2.2em; /* –ß—É—Ç—å –±–æ–ª—å—à–µ */
            font-weight: 700;
            color: var(--gold-color-light);
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); /* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤–µ—á–µ–Ω–∏—è */
        }
        
        /* --- –ö–Ω–æ–ø–∫–∞ "–í–∑–æ—Ä–≤–∞—Ç—å" (–°—Ç–∏–ª–∏ –Ω–µ –º–µ–Ω—è–µ–º, –æ–Ω–∞ —É–∂–µ —è—Ä–∫–∞—è) --- */
        /* ... (–°—Ç–∏–ª–∏ blastButton –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ) ... */

        /* --- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å (–¢–∞–±—ã) --- */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--tg-secondary-bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3); /* –£—Å–∏–ª–µ–Ω–Ω–∞—è —Ç–µ–Ω—å */
            z-index: 10;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: var(--tg-hint);
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s, transform 0.1s;
            text-decoration: none;
            user-select: none;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--tg-link);
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ë–∞–ª–∞–Ω—Å/–í—ã–≤–æ–¥" –≤ Nav Bar --- */
        .nav-item.withdraw-button {
            flex: 1.5; /* –î–∞–µ–º –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ */
            background-color: var(--green-highlight);
            color: var(--tg-button-text);
            font-weight: 600;
            margin: 5px 10px;
            border-radius: 12px; /* –ó–∞–∫—Ä—É–≥–ª—è–µ–º —É–≥–ª—ã */
            box-shadow: 0 4px 0 var(--green-shadow), 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        .nav-item.withdraw-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 var(--green-shadow);
        }
        
        .withdraw-button .icon {
            fill: var(--tg-button-text);
        }

        /* --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (Withdraw Modal) --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 20; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--tg-secondary-bg);
            margin: 15% auto; /* 15% —Å–≤–µ—Ä—Ö—É –∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
            padding: 20px;
            border-radius: 16px;
            width: 90%; 
            max-width: 400px;
            position: relative;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        @keyframes slideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-close {
            color: var(--tg-hint);
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: var(--tg-link);
            text-decoration: none;
            cursor: pointer;
        }

        .withdraw-form input[type="number"] {
            /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∏–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, –æ–Ω–∏ —É–∂–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ */
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--tg-hint);
            border-radius: 8px;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            box-sizing: border-box;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }
        
        /* --- –ê–Ω–∏–º–∞—Ü–∏—è –í–∑—Ä—ã–≤–∞ –°—É–Ω–¥—É–∫–∞ –∏ –ü–∞–¥–∞—é—â–∏—Ö –ó–≤–µ–∑–¥ --- */
        #explosion-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –∫–ª–∏–∫–∞–º */
        }
        
        .particle {
            position: fixed;
            width: 8px;
            height: 8px;
            background-color: var(--gold-color-light);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 101;
            pointer-events: none;
        }

        @keyframes fall {
            to {
                transform: translate(-50%, 100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* --- –°–µ–∫—Ü–∏—è –ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª–∏ --- */
        .withdrawal-request {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .withdrawal-request p {
            margin: 5px 0;
        }
        
        .admin-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 5px;
            transition: opacity 0.2s;
        }

        .btn-approve {
            background-color: var(--green-highlight);
            color: var(--tg-button-text);
        }

        .btn-reject {
            background-color: var(--dynamite-color);
            color: var(--tg-button-text);
        }
        
        /* ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ index.html, —Ç–∞–∫–∏–µ –∫–∞–∫ btn-gold, hint-text –∏ —Ç.–¥., –æ—Å—Ç–∞—é—Ç—Å—è) ... */

    </style>
</head>
<body>

    <div class="container">
        <div class="welcome-message" id="welcomeMessageEl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <div class="card balance-info">
            <div class="stat-item">
                <h3 id="starsBalance">0.00</h3>
                <p>–ó–≤–µ–∑–¥—ã (‚òÖ)</p>
            </div>
            <div class="stat-item">
                <h3 id="dynamiteCount">0</h3>
                <p>–î–∏–Ω–∞–º–∏—Ç (üß®)</p>
            </div>
        </div>

        <div id="miningSection" class="section-content active">
            
            <div class="blast-area">
                <div id="chestContainer" style="position: relative; margin: 0 auto; width: 250px; height: 250px;">
                    <button id="blastButton">
                        <span style="font-size: 2em;">üí£</span>
                        –í–∑–æ—Ä–≤–∞—Ç—å
                        <span>(–°–ø–∏—à–µ—Ç—Å—è 1 –î–∏–Ω–∞–º–∏—Ç)</span>
                    </button>
                    </div>
            </div>

            <div id="prizeMessage" style="opacity: 0;"></div>
            
            <div id="particlesContainer"></div> <div class="card">
                <h2>–ß—Ç–æ –¥–∞–ª—å—à–µ?</h2>
                <p class="hint-text">–ö–∞–∂–¥—ã–π –≤–∑—Ä—ã–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 1 –µ–¥–∏–Ω–∏—Ü—É –î–∏–Ω–∞–º–∏—Ç–∞ –∏ –¥–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ó–≤–µ–∑–¥ (‚òÖ) –∏–∑ —Å–ø–∏—Å–∫–∞ **0.1, 0.3, 0.5, 1, 3, 5**.</p>
                <p class="hint-text">–î–∏–Ω–∞–º–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –∏–ª–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É.</p>
                <button class="btn btn-primary" onclick="showSection('friendsSection', document.querySelector('.nav-item[data-section=\"friendsSection\"]'))">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</button>
            </div>
        </div>

        <div id="friendsSection" class="section-content">
            <div class="card">
                <h2>–ú–æ–∏ –†–µ—Ñ–µ—Ä–∞–ª—ã</h2>
                <div class="balance-info" style="margin-bottom: 20px;">
                    <div class="stat-item">
                        <h3 id="friendsCount">0</h3>
                        <p>–î—Ä—É–∑–µ–π</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="referralEarnings">0.00</h3>
                        <p>–î–æ—Ö–æ–¥ (‚òÖ)</p>
                    </div>
                </div>
                <p class="hint-text">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π! –í—ã –ø–æ–ª—É—á–∏—Ç–µ **2 –∑–≤–µ–∑–¥—ã** –∑–∞ –∫–∞–∂–¥–æ–≥–æ, –∫—Ç–æ –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä–∞—Ç—å, –∏ **10%** –æ—Ç –∏—Ö –¥–æ–±—ã—á–∏ –ó–≤–µ–∑–¥.</p>
                <label>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</label>
                <div class="referral-share">
                    <code id="referralLinkEl">–ó–∞–≥—Ä—É–∑–∫–∞...</code>
                    <button onclick="copyReferralLink()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M16 1h6v6l-2-2v-2h-3v-3l-2-2zm-8 0l-2 2h-2v3l-2 2h-2v-6h6zm8 16l2-2v-3l2-2h2v6h-6zm-8 0l-2 2h-2v-2l-2-2v-2h6z"/> <path d="M14 9h-4v4h4v-4zm-2 2h-2v-2h2v2z"/> <path d="M16 3l2 2v2l-2 2v-4l-2-2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="adminSection" class="section-content">
            <div class="card">
                <h2>–ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å</h2>
                <p class="hint-text">–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥. –í–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –≤–∞–º.</p>
                <button class="btn btn-primary" id="refreshAdminData">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                
                <div id="withdrawalRequestsList" style="margin-top: 15px;">
                    –ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫.
                </div>
            </div>
        </div>
        
    </div>
    
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('withdrawModal')">&times;</span>
            <h2>–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –ó–≤–µ–∑–¥ (‚òÖ)</h2>
            <div class="withdraw-form">
                <p class="hint-text" id="currentBalanceDisplay">–í–∞—à –±–∞–ª–∞–Ω—Å: 0.00 ‚òÖ</p>
                <label for="withdrawAmountInput">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (–º–∏–Ω. 50.00 ‚òÖ):</label>
                <input type="number" id="withdrawAmountInput" min="50.00" step="0.01" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">
                <button class="btn btn-gold" id="withdrawButton" disabled>–í—ã–≤–µ—Å—Ç–∏</button>
                <p class="hint-text">–°—É–º–º–∞ –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–∞ —Å –±–∞–ª–∞–Ω—Å–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –∞ –∑–∞—è–≤–∫–∞ –ø–æ–ø–∞–¥–µ—Ç –≤ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.</p>
                <p class="hint-text" style="color: var(--dynamite-color);">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 50.00 ‚òÖ</p>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" data-section="miningSection" onclick="showSection('miningSection', this)">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 1L3 12h3v8h12v-8h3L12 1zm0 2.373L17.755 9H12V3.373zM7 13h10v5H7v-5z"/></svg>
            –î–æ–±—ã—á–∞
        </div>
        <div class="nav-item" data-section="friendsSection" onclick="showSection('friendsSection', this)">
            <svg class="icon" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.57.85 2.22 1.84 2.47 2.76.02.09.02.19.02.3v1.34H23v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            –î—Ä—É–∑—å—è
        </div>
        <div class="nav-item" data-section="adminSection" id="adminNav" style="display: none;" onclick="showSection('adminSection', this)">
             <svg class="icon" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-2c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3z"/></svg>
            –ê–¥–º–∏–Ω
        </div>
        <div class="nav-item withdraw-button" id="withdrawButtonNav" onclick="showWithdrawModal()">
            <h3 id="starsBalanceNav" style="font-size: 1.2em; margin: 0; color: var(--tg-button-text);">0.00 ‚òÖ</h3>
            <p style="font-size: 0.7em; margin: 0; color: rgba(255, 255, 255, 0.7);">–í—ã–≤–æ–¥</p>
        </div>
    </div>
    
    <script>
        const tg = window.Telegram.WebApp;
        const WEBAPP_URL = '{{ WEBAPP_URL }}';
        const startParam = '{{ start_param }}';
        
        let userData = {};
        const MIN_WITHDRAWAL_AMOUNT = 50.00;

        // --- DOM Elements ---
        const welcomeMessageEl = document.getElementById('welcomeMessageEl');
        const starsBalanceEl = document.getElementById('starsBalance');
        const starsBalanceNavEl = document.getElementById('starsBalanceNav');
        const dynamiteCountEl = document.getElementById('dynamiteCount');
        const friendsCountEl = document.getElementById('friendsCount');
        const referralLinkEl = document.getElementById('referralLinkEl');
        const prizeMessageEl = document.getElementById('prizeMessage');
        const blastButton = document.getElementById('blastButton');
        const withdrawModal = document.getElementById('withdrawModal');
        const withdrawAmountInput = document.getElementById('withdrawAmountInput');
        const withdrawButton = document.getElementById('withdrawButton');
        const adminNav = document.getElementById('adminNav');
        const withdrawalRequestsList = document.getElementById('withdrawalRequestsList');
        const refreshAdminData = document.getElementById('refreshAdminData');
        const currentBalanceDisplay = document.getElementById('currentBalanceDisplay');
        const particlesContainer = document.getElementById('particlesContainer');


        // --- UI Functions ---

        function showSection(sectionId, element) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            if (sectionId === 'adminSection') {
                loadAdminData();
            }
        }
        
        function updateUI() {
            if (!userData.user) return;
            
            starsBalanceEl.textContent = userData.user.stars.toFixed(2);
            starsBalanceNavEl.textContent = userData.user.stars.toFixed(2) + ' ‚òÖ';
            dynamiteCountEl.textContent = userData.user.dynamite;
            friendsCountEl.textContent = userData.referral_stats.friends_count;
            // referralEarningsEl.textContent = userData.referral_stats.referral_earnings.toFixed(2); // –ü–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Ç–æ—á–Ω–æ –Ω–∞ –±—ç–∫–µ

            welcomeMessageEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${userData.user.username || '–ú–∞–π–Ω–µ—Ä'}! –î–æ–±—ã–≤–∞–π –ó–≤–µ–∑–¥—ã!`;

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞ –∏ –µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
            const currentBalance = userData.user.stars || 0;
            currentBalanceDisplay.textContent = `–í–∞—à –±–∞–ª–∞–Ω—Å: ${currentBalance.toFixed(2)} ‚òÖ`;
            
            const withdrawAmount = parseFloat(withdrawAmountInput.value);
            
            const isInputValid = !isNaN(withdrawAmount) && withdrawAmount >= MIN_WITHDRAWAL_AMOUNT && withdrawAmount <= currentBalance;
            withdrawButton.disabled = !isInputValid;
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            if (userData.is_admin) {
                adminNav.style.display = 'flex';
            } else {
                adminNav.style.display = 'none';
            }
        }

        function showWithdrawModal() {
            withdrawModal.style.display = 'block';
            tg.expand();
            updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            if (event.target == withdrawModal) {
                closeModal('withdrawModal');
            }
        }

        // --- Core Logic ---

        async function loadInitialData() {
            tg.showProgress(true);
            try {
                const response = await fetch('/api/v1/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init_data: tg.initData })
                });
                const data = await response.json();
                
                if (data.user) {
                    userData = data;
                    updateUI();
                    
                    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
                    const botUsername = "{{ BOT_USERNAME }}"; // –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã botUsername –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω –≤ index.html –∏–∑ main.py
                    const userId = data.user.id;
                    referralLinkEl.textContent = `https://t.me/${data.user.username || 'YourBotUsername'}?start=${userId}`;
                }

            } catch (error) {
                console.error("Error loading initial data:", error);
                welcomeMessageEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.';
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
            } finally {
                tg.showProgress(false);
            }
        }
        
        // --- –ê–Ω–∏–º–∞—Ü–∏—è –í–∑—Ä—ã–≤–∞ –∏ –ü–∞–¥–µ–Ω–∏—è ---
        function triggerExplosionAnimation(prize) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —á–∞—Å—Ç–∏—Ü—ã
            particlesContainer.innerHTML = '';
            
            const numParticles = 30; // 30 —á–∞—Å—Ç–∏—Ü –¥–ª—è –≤–∑—Ä—ã–≤–∞
            const explosionDuration = 500; // ms
            const fallDuration = 2000; // ms
            const buttonRect = blastButton.getBoundingClientRect();
            const centerX = buttonRect.left + buttonRect.width / 2;
            const centerY = buttonRect.top + buttonRect.height / 2;

            // 1. –ê–Ω–∏–º–∞—Ü–∏—è –≤–∑—Ä—ã–≤–∞ (–∫—Ä–∞—Å–Ω—ã–µ/–∂–µ–ª—Ç—ã–µ —á–∞—Å—Ç–∏—Ü—ã)
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.backgroundColor = i % 2 === 0 ? 'var(--gold-color-light)' : 'var(--dynamite-color)';
                particle.style.width = particle.style.height = `${Math.random() * 5 + 5}px`;
                
                // –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
                particle.style.left = `${centerX}px`;
                particle.style.top = `${centerY}px`;
                
                // –°–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 100 + 50;
                const endX = centerX + Math.cos(angle) * distance;
                const endY = centerY + Math.sin(angle) * distance;
                
                particle.style.transition = `transform ${explosionDuration}ms ease-out, opacity 0.5s`;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                setTimeout(() => {
                    particle.style.opacity = '1';
                    particle.style.transform = `translate(${endX - centerX}px, ${endY - centerY}px)`;
                }, 50);

                // –£–±–∏—Ä–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –≤–∑—Ä—ã–≤–∞ —á–µ—Ä–µ–∑ 0.5s
                setTimeout(() => {
                    particle.remove();
                }, explosionDuration);
                
                particlesContainer.appendChild(particle);
            }
            
            // 2. –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–∞—é—â–∏—Ö –∑–≤–µ–∑–¥ (—á–µ—Ä–µ–∑ 0.5s –ø–æ—Å–ª–µ –≤–∑—Ä—ã–≤–∞)
            setTimeout(() => {
                const numStars = prize * 10; // –ß–µ–º –±–æ–ª—å—à–µ –ø—Ä–∏–∑, —Ç–µ–º –±–æ–ª—å—à–µ –∑–≤–µ–∑–¥ –ø–∞–¥–∞–µ—Ç
                for (let i = 0; i < numStars; i++) {
                    const star = document.createElement('div');
                    star.classList.add('particle'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∫–ª–∞—Å—Å particle
                    star.style.backgroundColor = 'var(--gold-color-light)';
                    star.style.width = star.style.height = `${Math.random() * 10 + 10}px`; // –ó–≤–µ–∑–¥—ã —á—É—Ç—å –±–æ–ª—å—à–µ
                    star.textContent = '‚òÖ';
                    star.style.borderRadius = '0';
                    star.style.fontSize = '8px';
                    star.style.textAlign = 'center';
                    star.style.lineHeight = '8px';
                    
                    // –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ - –≤ –∑–æ–Ω–µ –≤–∑—Ä—ã–≤–∞
                    star.style.left = `${centerX + Math.random() * 40 - 20}px`;
                    star.style.top = `${centerY + Math.random() * 40 - 20}px`;
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è
                    const delay = Math.random() * 200;
                    star.style.animation = `fall ${fallDuration}ms ease-in ${delay}ms forwards`;

                    particlesContainer.appendChild(star);
                    
                    // –£–¥–∞–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—É –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è
                    setTimeout(() => star.remove(), fallDuration + delay + 100);
                }
            }, explosionDuration);
            
        }

        async function blast() {
            if (blastButton.disabled) return;
            
            blastButton.disabled = true;
            tg.showProgress(true);
            prizeMessageEl.style.opacity = '0'; // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

            try {
                const response = await fetch('/api/v1/blast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init_data: tg.initData })
                });

                if (!response.ok) {
                    const error = await response.json();
                    tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –≤–∑—Ä—ã–≤–∞: ${error.detail}`);
                    return;
                }
                
                const data = await response.json();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–µ—Ä–µ–¥ –∞–Ω–∏–º–∞—Ü–∏–µ–π
                userData.user.stars = data.new_stars;
                userData.user.dynamite = data.new_dynamite;
                updateUI();
                
                // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
                triggerExplosionAnimation(data.prize_amount);

                // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏–∑–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                prizeMessageEl.textContent = `üéâ –í—ã –¥–æ–±—ã–ª–∏ ${data.prize_amount.toFixed(2)} –ó–≤–µ–∑–¥ (‚òÖ)!`;
                prizeMessageEl.style.opacity = '1';
                
            } catch (error) {
                tg.showAlert(`‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'}`);
                console.error("Blast Error:", error);
            } finally {
                blastButton.disabled = false;
                tg.showProgress(false);
            }
        }
        
        async function requestWithdraw() {
            const amount = parseFloat(withdrawAmountInput.value);
            const currentBalance = userData.user.stars || 0;
            
            if (isNaN(amount) || amount < MIN_WITHDRAWAL_AMOUNT) {
                tg.showAlert(`–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ ${MIN_WITHDRAWAL_AMOUNT.toFixed(2)} ‚òÖ.`);
                return;
            }
            if (amount > currentBalance) {
                 tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.');
                return;
            }

            withdrawButton.disabled = true;
            tg.showProgress(true);

            try {
                const response = await fetch('/api/v1/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init_data: tg.initData, amount: amount })
                });

                if (!response.ok) {
                    const error = await response.json();
                    tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞: ${error.detail}`);
                    return;
                }
                
                // –£—Å–ø–µ—Ö
                const data = await response.json();
                tg.showAlert(`‚úÖ –£—Å–ø–µ—Ö! ${data.message}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (–±–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)
                await loadInitialData(); 
                closeModal('withdrawModal');

            } catch (error) {
                const errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–≤–æ–¥.';
                tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞: ${errorMessage}`);
                console.error("Withdrawal Error:", error);
            } finally {
                withdrawButton.disabled = false;
                tg.showProgress(false);
                updateUI();
            }
        }
        
        // --- Admin Panel Logic ---

        refreshAdminData.addEventListener('click', loadAdminData);
        
        async function loadAdminData() {
            if (!userData.is_admin) return;
            
            withdrawalRequestsList.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            tg.showProgress(true);

            try {
                const response = await fetch('/api/v1/admin/withdrawals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init_data: tg.initData })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    withdrawalRequestsList.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.detail}`;
                    return;
                }
                
                const data = await response.json();
                renderAdminWithdrawals(data.withdrawals);

            } catch (error) {
                console.error("Admin Data Error:", error);
                withdrawalRequestsList.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫.';
            } finally {
                tg.showProgress(false);
            }
        }
        
        function renderAdminWithdrawals(withdrawals) {
            if (withdrawals.length === 0) {
                withdrawalRequestsList.innerHTML = '–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫.';
                return;
            }
            
            let html = '';
            withdrawals.forEach(req => {
                html += `
                    <div class="withdrawal-request">
                        <div>
                            <p><strong>ID: ${req.id}</strong></p>
                            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @${req.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                            <p>–°—É–º–º–∞: <strong>${req.amount.toFixed(2)} ‚òÖ</strong></p>
                            <p class="hint-text">${new Date(req.created_at).toLocaleString()}</p>
                        </div>
                        <div class="admin-actions">
                            <button class="btn-approve" onclick="handleAdminAction(${req.id}, 'approve', this)">–û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button class="btn-reject" onclick="handleAdminAction(${req.id}, 'reject', this)">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            });
            
            withdrawalRequestsList.innerHTML = html;
        }

        async function handleAdminAction(withdrawalId, action, buttonEl) {
            buttonEl.disabled = true;
            tg.showProgress(true);

            try {
                const response = await fetch('/api/v1/admin/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        init_data: tg.initData, 
                        withdrawal_id: withdrawalId, 
                        action: action 
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    tg.showAlert(`‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}`);
                    return;
                }
                
                tg.showAlert(`‚úÖ –ó–∞—è–≤–∫–∞ ID ${withdrawalId} ${action === 'approve' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}.`);
                loadAdminData(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫

            } catch (error) {
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞.');
                console.error("Admin Action Error:", error);
            } finally {
                buttonEl.disabled = false;
                tg.showProgress(false);
            }
        }
        
        // --- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI ---

        function copyReferralLink() {
            const link = referralLinkEl.textContent;
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            tg.showPopup({
                title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ',
                message: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.',
                buttons: [{ text: 'OK', type: 'default' }]
            });
        }
        
        // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞ –∏ –∫–ª–∏–∫–∞
        withdrawAmountInput.addEventListener('input', updateUI);
        withdrawButton.addEventListener('click', requestWithdraw);

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
             loadInitialData();
             blastButton.addEventListener('click', blast);
        });

    </script>
</body>
</html>
