<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Miner App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Telegram --- */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #18222d);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #91a8c0);
            --tg-link: var(--tg-theme-link-color, #65b8ff);
            --tg-button: var(--tg-theme-button-color, #5288c1);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #232e3c);
            
            /* –°—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ */
            --gold-color-light: #ffd700;
            --gold-color-dark: #ffb300;
            --dynamite-color: #e74c3c;
            --success-green: #2ecc71; /* –î–ª—è –ø–ª–∞–≤–∞—é—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- –û–±—â–∏–π –º–∞–∫–µ—Ç --- */
        .container {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 70px; /* –ú–µ—Å—Ç–æ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
            position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
        }

        /* --- –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –±–ª–æ–∫–∏ --- */
        .card {
            background-color: var(--tg-secondary-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        /* --- –ü–õ–ê–í–ê–Æ–©–ò–ô –ë–ê–õ–ê–ù–° (–ù–û–í–û–ï) --- */
        .balance-float-box {
            position: fixed;
            bottom: 75px; /* –ù–∞–¥ –Ω–∞–≤–±–∞—Ä–æ–º */
            right: 15px;
            background: linear-gradient(135deg, var(--success-green), #27ae60);
            color: white;
            padding: 10px 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            font-size: 1.1em;
            font-weight: 700;
            z-index: 9;
            animation: fadeIn 0.5s ease-out;
        }

        .balance-float-box span:first-child {
            margin-right: 8px;
            font-size: 1.2em;
        }

        /* --- –ö–Ω–æ–ø–∫–∞ "–í–∑–æ—Ä–≤–∞—Ç—å" --- */
        .blast-area {
            text-align: center;
            margin: 40px 0;
            position: relative; /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
        }

        #blastButton {
            /* –û—Å—Ç–∞–≤—å—Ç–µ —Å—Ç–∏–ª—å, –Ω–æ –¥–æ–±–∞–≤—å—Ç–µ transition –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
            width: 200px;
            height: 200px;
            border-radius: 50%;
            font-size: 1.4em;
            padding: 0;
            background: linear-gradient(145deg, #ff6b6b, var(--dynamite-color));
            color: var(--tg-button-text);
            border: 6px solid #ff9393;
            box-shadow: 0 8px 0 #b93e32, 0 0 15px rgba(255, 107, 107, 0.7);
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        #blastButton:active {
            box-shadow: 0 2px 0 #b93e32, 0 0 10px rgba(255, 107, 107, 0.5);
            transform: translateY(6px) scale(0.98);
        }

        /* --- –ê–ù–ò–ú–ê–¶–ò–Ø –í–ó–†–´–í–ê (–ù–û–í–û–ï) --- */
        #chestAnimation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
        }

        .exploding {
            animation: blastFade 1.2s ease-out forwards;
        }
        
        .prize-float {
            position: absolute;
            font-size: 1.5em;
            font-weight: 900;
            color: var(--gold-color-light);
            text-shadow: 0 0 5px #1a1a1a;
            animation: floatUp 1.5s ease-out forwards;
            opacity: 0;
            z-index: 3;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }

        @keyframes blastFade {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        /* --- –°–µ–∫—Ü–∏—è "–ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å" (–ù–û–í–û–ï) --- */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .admin-table th, .admin-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--tg-bg);
            word-break: break-word;
        }
        .admin-table th {
            color: var(--tg-hint);
            font-weight: 500;
        }
        .status-pending { color: var(--gold-color-light); }
        .status-approved { color: var(--success-green); }
        .status-rejected { color: var(--dynamite-color); }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ */
        .action-btn {
            padding: 5px 10px;
            border-radius: 6px;
            border: none;
            font-size: 0.8em;
            cursor: pointer;
            margin-right: 5px;
        }
        .btn-approve { background-color: var(--success-green); color: white; }
        .btn-reject { background-color: var(--dynamite-color); color: white; }

        /* –ü—Ä–æ—á–∏–µ —Å—Ç–∏–ª–∏ */
        .welcome-message { text-align: center; font-size: 1.1em; margin-bottom: 20px; }
        .hint-text { color: var(--tg-hint); font-size: 0.9em; margin-top: 10px; }
        .nav-bar { /* ... (—Å—Ç–∏–ª–∏ nav-bar –æ—Å—Ç–∞—é—Ç—Å—è, –Ω–æ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ª–æ–≥–∏–∫–∏ –∞–¥–º–∏–Ω–∞) */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--tg-secondary-bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        /* ... –¥—Ä—É–≥–∏–µ —Å—Ç–∏–ª–∏ (btn, input, etc.) ... */
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: var(--tg-hint);
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            user-select: none;
        }
        .nav-item.active { color: var(--tg-link); }
        .icon { width: 24px; height: 24px; fill: currentColor; margin-bottom: 3px; }

    </style>
</head>
<body>

    <div class="container">
        <div class="welcome-message" id="welcomeMessageEl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <div id="miningSection" class="section-content active">
            
            <div class="blast-area">
                <div id="chestAnimation">
                    <span id="chestIcon">üì¶</span> 
                </div>
                <button id="blastButton">
                    <span>üß®</span>
                    –í–∑–æ—Ä–≤–∞—Ç—å
                    <span>(–°–ø–∏—à–µ—Ç—Å—è 1 –î–∏–Ω–∞–º–∏—Ç)</span>
                </button>
            </div>

            <div id="prizeMessage"></div>

            <div class="card">
                <h2>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ú–∞–π–Ω–∏–Ω–≥–∞</h2>
                <p class="hint-text">–ö–∞–∂–¥—ã–π –≤–∑—Ä—ã–≤ –¥–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–∑: 0.1, 0.3, 0.5, 1, 3 –∏–ª–∏ 5 –ó–≤–µ–∑–¥ (‚òÖ).</p>
                <p class="hint-text">–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç **2 ‚òÖ** –≤ –ø–æ–¥–∞—Ä–æ–∫. –ó–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ **10%** –æ—Ç –∏—Ö –¥–æ–±—ã—á–∏.</p>
                <button class="btn btn-primary" onclick="showSection('friendsSection')">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</button>
            </div>
        </div>

        <div id="friendsSection" class="section-content">
            <div class="card">
                <h2>–ú–æ–∏ –†–µ—Ñ–µ—Ä–∞–ª—ã</h2>
                <div class="balance-info" style="justify-content: space-around; margin-bottom: 20px;">
                    <div class="stat-item">
                        <h3 id="friendsCount">0</h3>
                        <p>–î—Ä—É–∑–µ–π</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="referralEarnings">0.00</h3>
                        <p>–î–æ—Ö–æ–¥ (‚òÖ)</p>
                    </div>
                </div>
                
                <p class="hint-text">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å **–±–æ–Ω—É—Å—ã –î–∏–Ω–∞–º–∏—Ç–∞** –∏ **10%** –æ—Ç –∏—Ö –¥–æ–±—ã—á–∏ –ó–≤–µ–∑–¥!</p>

                <label>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</label>
                <div class="referral-share">
                    <code id="referralLinkEl">–ó–∞–≥—Ä—É–∑–∫–∞...</code>
                    <button onclick="copyReferralLink()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M16 1h6v6l-2-2v-2h-3v-3l-2-2zm-8 0l-2 2h-2v3l-2 2h-2v-6h6zm8 16l2-2v-3l2-2h2v6h-6zm-8 0l-2 2h-2v-2l-2-2v-2h6z"/><path d="M14 9h-4v4h4v-4zm-2 2h-2v-2h2v2z"/><path d="M16 3l2 2v2l-2 2v-4l-2-2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="withdrawSection" class="section-content">
            <div class="card withdraw-form">
                <h2>–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –ó–≤–µ–∑–¥ (‚òÖ)</h2>
                <div class="user-id-display">
                    <span id="telegramUserIdDisplay">–í–∞—à Telegram ID: –ù–µ –ø–æ–ª—É—á–µ–Ω</span>
                </div>
                
                <p class="hint-text">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: **50.0 ‚òÖ**. –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
                
                <label for="withdrawAmount">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (‚òÖ)</label>
                <input type="number" id="withdrawAmount" placeholder="50.00" min="50.0" step="0.01">
                
                <button class="btn btn-gold" id="withdrawButton" onclick="withdraw()">
                    –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                </button>
                <p class="hint-text" id="withdrawError" style="color: var(--dynamite-color); display: none;">–û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞.</p>
            </div>
        </div>
        
        <div id="adminSection" class="section-content">
            <div class="card">
                <h2>–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <p class="hint-text" id="adminWelcome">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</p>
                
                <div id="withdrawalListContainer">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–Æ–∑–µ—Ä</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalTableBody">
                            <tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </div> <div class="balance-float-box" id="balanceFloatBox">
        <span>‚òÖ</span>
        <span id="starsBalance">0.00</span>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showSection('miningSection')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L9 6l3 4 3-4-3-4zM7 11h10l-2 5h-6l-2-5zM4 17h16l-1 4H5l-1-4z"/></svg>
            –î–æ–±—ã—á–∞
        </div>
        <div class="nav-item" onclick="showSection('friendsSection')">
             <svg class="icon" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.54.91 2.49 2.1 2.97 3.45V19h7v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            –î—Ä—É–∑—å—è
        </div>
        <div class="nav-item" onclick="showSection('withdrawSection')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M21 18c.55 0 1-.45 1-1V7c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h18zm-2-9H5v6h14V9zm-9 5l-4-4h8l-4 4z"/></svg>
            –í—ã–≤–æ–¥
        </div>
        <div class="nav-item" id="adminNavItem" onclick="showSection('adminSection')" style="display: none;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 18c-2.67-1.35-5.33-4.73-6-9.67V6.3l6-2.65 6 2.65v3.03c-.67 4.94-3.33 8.32-6 9.67zm0-10c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
            –ê–¥–º–∏–Ω
        </div>
    </div>


    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        const tg = window.Telegram.WebApp;
        const apiUrl = ''; 

        const safeUser = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : {};

        const userState = {
            stars: 0.0,
            dynamite: 0,
            friendsCount: 0,
            referralEarnings: 0.0, // –ù–û–í–û–ï: –î–æ—Ö–æ–¥ –æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
            is_admin: false,
            user: safeUser,
            initData: tg.initData,
            botUsername: 'star_miner_bot',
        };

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã UI ---
        const welcomeMessageEl = document.getElementById('welcomeMessageEl');
        const starsBalanceEl = document.getElementById('starsBalance');
        const dynamiteCountEl = document.getElementById('dynamiteCount');
        const friendsCountEl = document.getElementById('friendsCount');
        const referralEarningsEl = document.getElementById('referralEarnings');
        const referralLinkEl = document.getElementById('referralLinkEl');
        const blastButton = document.getElementById('blastButton');
        const prizeMessageEl = document.getElementById('prizeMessage');
        const telegramUserIdDisplay = document.getElementById('telegramUserIdDisplay'); 
        const adminNavItem = document.getElementById('adminNavItem');
        const withdrawalTableBody = document.getElementById('withdrawalTableBody');
        const chestAnimationEl = document.getElementById('chestAnimation');
        const chestIconEl = document.getElementById('chestIcon');
        const balanceFloatBox = document.getElementById('balanceFloatBox');

        // --- –£—Ç–∏–ª–∏—Ç—ã API ---
        async function apiPost(endpoint, data = {}) {
            const headers = { 'Content-Type': 'application/json' };

            const response = await fetch(apiUrl + endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ init_data: userState.initData, ...data })
            });

            const result = await response.json();

            if (!response.ok) {
                const errorMessage = result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API';
                throw new Error(errorMessage);
            }

            return result;
        }

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI ---
        function updateUI() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞–≤–∞—é—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
            starsBalanceEl.textContent = userState.stars.toFixed(2);
            dynamiteCountEl.textContent = userState.dynamite;
            friendsCountEl.textContent = userState.friendsCount;
            referralEarningsEl.textContent = userState.referralEarnings.toFixed(2); // –ù–û–í–û–ï –ü–û–õ–ï
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (userState.user && userState.user.id) {
                 const username = userState.user.username ? `@${userState.user.username}` : `(ID: ${userState.user.id})`;
                 telegramUserIdDisplay.textContent = `–í–∞—à –∞–∫–∫–∞—É–Ω—Ç: ${username}`;
            } else {
                 telegramUserIdDisplay.textContent = 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –û–®–ò–ë–ö–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò'; 
            }
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π "–í–∑–æ—Ä–≤–∞—Ç—å"
            blastButton.disabled = userState.dynamite <= 0;
            blastButton.style.opacity = userState.dynamite <= 0 ? 0.5 : 1;
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–æ–π "–ê–¥–º–∏–Ω"
            adminNavItem.style.display = userState.is_admin ? 'flex' : 'none';

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ì–ª–∞–≤–Ω–æ–π –ö–Ω–æ–ø–∫–æ–π Telegram
            const currentSectionId = document.querySelector('.section-content.active').id;
            if (currentSectionId === 'miningSection' && userState.dynamite > 0) {
                 tg.MainButton.setText(`–í–∑–æ—Ä–≤–∞—Ç—å (${userState.dynamite} üß®)`);
                 tg.MainButton.show();
            } else {
                 tg.MainButton.hide();
            }
        }

        // --- –õ–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ---
        async function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navItem = document.querySelector(`.nav-bar .nav-item[onclick*="${sectionId}"]`);
            if (navItem) navItem.classList.add('active');

            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            if (sectionId === 'adminSection' && userState.is_admin) {
                 await loadWithdrawals();
            }

            // –ù–∞–∑–Ω–∞—á–∞–µ–º MainButton
            tg.MainButton.offClick(blast);
            tg.MainButton.offClick(showWithdrawalPrompt);
            if (sectionId === 'miningSection') {
                tg.MainButton.onClick(blast);
            } else if (sectionId === 'withdrawSection') {
                // –ï—Å–ª–∏ —Ö–æ—Ç–∏–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MainButton –¥–ª—è –≤—ã–≤–æ–¥–∞
                // tg.MainButton.onClick(showWithdrawalPrompt);
            }
            
            updateUI();
        }

        // --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---

        async function loadInitialData() {
            if (!userState.initData || !userState.user || !userState.user.id) {
                welcomeMessageEl.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram.';
                return;
            }

            tg.expand();
            tg.setHeaderColor('secondary_bg_color');
            tg.enableClosingConfirmation();

            try {
                const data = await apiPost('/api/v1/data');
                
                userState.stars = data.user_data.stars;
                userState.dynamite = data.user_data.dynamite;
                userState.friendsCount = data.referrals_count;
                userState.referralEarnings = data.user_data.referral_earnings; // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Ö–æ–¥–∞
                userState.botUsername = data.bot_username;
                userState.is_admin = data.is_admin === 'True'; // –í–∞–∂–Ω–æ: FastAPI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–π

                const name = userState.user.first_name || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                welcomeMessageEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${name}! –ì–æ—Ç–æ–≤ –¥–æ–±—ã–≤–∞—Ç—å –ó–≤–µ–∑–¥—ã?`;
                referralLinkEl.textContent = `https://t.me/${userState.botUsername}?start=${userState.user.id}`;
                
            } catch (error) {
                welcomeMessageEl.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`;
                tg.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
            } finally {
                updateUI();
                tg.MainButton.onClick(blast);
            }
        }

        async function blast() {
            if (userState.dynamite <= 0) {
                tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –î–∏–Ω–∞–º–∏—Ç–∞ –¥–ª—è –≤–∑—Ä—ã–≤–∞!');
                return;
            }

            blastButton.disabled = true;
            tg.MainButton.showProgress(true);
            
            // 1. –ê–Ω–∏–º–∞—Ü–∏—è: –°–º–µ–Ω–∞ –∏–∫–æ–Ω–∫–∏ –Ω–∞ –≤–∑—Ä—ã–≤
            chestIconEl.textContent = 'üí•';
            chestAnimationEl.classList.add('exploding');


            try {
                const data = await apiPost('/api/v1/blast');

                const oldStars = userState.stars;

                userState.stars = data.new_stars;
                userState.dynamite = data.new_dynamite;
                userState.referralEarnings += data.referrer_bonus; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Ö–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ (–µ—Å–ª–∏ –æ–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä)

                const prize = data.prize_amount.toFixed(2);
                
                // 2. –ê–Ω–∏–º–∞—Ü–∏—è: –í—ã–≤–æ–¥ –ø—Ä–∏–∑–∞
                const prizeFloat = document.createElement('div');
                prizeFloat.classList.add('prize-float');
                prizeFloat.textContent = `+${prize} ‚òÖ`;
                chestAnimationEl.appendChild(prizeFloat);

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏–∑–µ
                prizeMessageEl.textContent = `üí• –£—Å–ø–µ—Ö! –í—ã –¥–æ–±—ã–ª–∏ ${prize} ‚òÖ!`;
                if (data.referrer_bonus > 0) {
                    prizeMessageEl.textContent += ` (–ë–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–∞–ª—É: +${data.referrer_bonus.toFixed(2)} ‚òÖ)`;
                }
                prizeMessageEl.style.opacity = 1;

                // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                await new Promise(resolve => setTimeout(resolve, 1500)); 

            } catch (error) {
                tg.showAlert(`–û—à–∏–±–∫–∞ –≤–∑—Ä—ã–≤–∞: ${error.message}`);
                console.error("Blast Error:", error);
            } finally {
                blastButton.disabled = false;
                tg.MainButton.showProgress(false);
                updateUI();
                
                // 3. –ê–Ω–∏–º–∞—Ü–∏—è: –û—á–∏—Å—Ç–∫–∞
                chestAnimationEl.classList.remove('exploding');
                chestIconEl.textContent = 'üì¶';
                prizeMessageEl.style.opacity = 0;
                chestAnimationEl.innerHTML = '<span id="chestIcon">üì¶</span>'; // –°–±—Ä–æ—Å
            }
        }

        async function withdraw() {
            const withdrawAmountInput = document.getElementById('withdrawAmount');
            const withdrawErrorEl = document.getElementById('withdrawError');
            const amount = parseFloat(withdrawAmountInput.value);
            const MIN_WITHDRAW = 50.0;
            
            if (isNaN(amount) || amount < MIN_WITHDRAW) {
                withdrawErrorEl.textContent = `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: ${MIN_WITHDRAW.toFixed(2)} ‚òÖ.`;
                withdrawErrorEl.style.display = 'block';
                return;
            }
            if (amount > userState.stars) {
                withdrawErrorEl.textContent = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –í–∞—à –±–∞–ª–∞–Ω—Å: ${userState.stars.toFixed(2)} ‚òÖ.`;
                withdrawErrorEl.style.display = 'block';
                return;
            }
            
            withdrawErrorEl.style.display = 'none';

            tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥ ${amount.toFixed(2)} ‚òÖ?`, async (isConfirmed) => {
                if (!isConfirmed) return;

                const withdrawButton = document.getElementById('withdrawButton');
                withdrawButton.disabled = true;
                tg.showProgress(true);

                try {
                    const data = await apiPost('/api/v1/withdraw', { amount: amount }); 
                    
                    userState.stars = data.new_stars; // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                    tg.showAlert(`‚úÖ ${data.message}`);
                    
                    withdrawAmountInput.value = '';

                } catch (error) {
                    const errorMessage = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–≤–æ–¥.';
                    tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞: ${errorMessage}`);
                    console.error("Withdrawal Error:", error);
                } finally {
                    withdrawButton.disabled = false;
                    tg.showProgress(false);
                    updateUI();
                }
            });
        }
        
        // --- –õ–æ–≥–∏–∫–∞ –ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª–∏ (–ù–û–í–û–ï) ---
        async function loadWithdrawals() {
            if (!userState.is_admin) {
                tg.showAlert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.');
                return;
            }

            document.getElementById('adminWelcome').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            withdrawalTableBody.innerHTML = '';

            try {
                const data = await apiPost('/api/v1/admin/withdrawals');
                const withdrawals = data.withdrawals;
                
                if (withdrawals.length === 0) {
                    withdrawalTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ù–µ—Ç –∑–∞—è–≤–æ–∫.</td></tr>';
                    document.getElementById('adminWelcome').textContent = `–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: 0`;
                    return;
                }

                document.getElementById('adminWelcome').textContent = `–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: ${withdrawals.length}. –û–∂–∏–¥–∞—é—Ç: ${withdrawals.filter(w => w.status === 'pending').length}`;
                
                let html = '';
                withdrawals.forEach(w => {
                    const date = new Date(w.created_at).toLocaleDateString();
                    const statusClass = `status-${w.status}`;
                    
                    let actions = '';
                    if (w.status === 'pending') {
                        actions = `
                            <button class="action-btn btn-approve" onclick="processWithdrawal(${w.id}, 'approve')">‚úÖ –í—ã–ø–ª–∞—á–µ–Ω–æ</button>
                            <button class="action-btn btn-reject" onclick="processWithdrawal(${w.id}, 'reject')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        `;
                    } else {
                        actions = '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ';
                    }

                    html += `
                        <tr>
                            <td>${w.id}</td>
                            <td>${w.username || `ID:${w.user_id}`}</td>
                            <td>${w.amount.toFixed(2)} ‚òÖ</td>
                            <td><span class="${statusClass}">${w.status} (${date})</span></td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });

                withdrawalTableBody.innerHTML = html;

            } catch (error) {
                tg.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫: ${error.message}`);
                console.error("Admin Load Error:", error);
                document.getElementById('adminWelcome').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫.';
            }
        }

        async function processWithdrawal(withdrawalId, action) {
            tg.showConfirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ '${action}' –¥–ª—è –∑–∞—è–≤–∫–∏ #${withdrawalId}?`, async (isConfirmed) => {
                if (!isConfirmed) return;

                tg.showProgress(true);
                try {
                    const data = await apiPost('/api/v1/admin/action', { withdrawal_id: withdrawalId, action: action });
                    tg.showNotification({ text: data.message, type: 'success' });
                    await loadWithdrawals(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } catch (error) {
                    tg.showAlert(`–û—à–∏–±–∫–∞: ${error.message}`);
                } finally {
                    tg.showProgress(false);
                }
            });
        }
        
        // --- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI ---

        function copyReferralLink() {
            const link = referralLinkEl.textContent;
            navigator.clipboard.writeText(link).then(() => {
                 tg.showPopup({
                    title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ',
                    message: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.',
                    buttons: [{ text: 'OK', type: 'default' }]
                });
            }).catch(err => {
                 tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
            });
        }
        
        // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞
        document.getElementById('withdrawAmount').addEventListener('input', updateUI);
        
        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
             loadInitialData();
             blastButton.addEventListener('click', blast);
        });

    </script>
</body>
</html>
