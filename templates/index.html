<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Star Miner App</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Telegram --- */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #18222d);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #91a8c0);
            --tg-link: var(--tg-theme-link-color, #65b8ff);
            --tg-button: var(--tg-theme-button-color, #5288c1);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #232e3c);
            
            /* –ó–æ–ª–æ—Ç—ã–µ —Å—Ç–∏–ª–∏ */
            --gold-color-light: #ffd700;
            --gold-color-dark: #ffb300;
            --gold-gradient: linear-gradient(145deg, var(--gold-color-light), var(--gold-color-dark));
            --dynamite-color: #e74c3c;
            --dynamite-gradient: linear-gradient(145deg, #ff6b6b, var(--dynamite-color));
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            
            /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            overflow-x: hidden;
            width: 100%;
        }

        /* --- –û–±—â–∏–π –º–∞–∫–µ—Ç --- */
        .container {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 70px; /* –ú–µ—Å—Ç–æ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        }

        /* --- –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –±–ª–æ–∫–∏ --- */
        .card {
            background-color: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .balance-info {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item h3 {
            margin: 0;
            font-size: 2em;
            font-weight: 700;
            color: var(--gold-color-light);
        }

        .stat-item p {
            margin: 5px 0 0 0;
            font-size: 0.8em;
            color: var(--tg-hint);
        }

        .welcome-message {
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        /* --- –ö–Ω–æ–ø–∫–∏ --- */
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
            color: var(--tg-button-text);
        }

        .btn-gold {
            background: var(--gold-gradient);
            color: #1a1a1a;
            box-shadow: 0 4px 0 var(--gold-color-dark);
        }

        .btn-gold:active {
            box-shadow: 0 1px 0 var(--gold-color-dark);
            transform: translateY(3px);
        }
        
        .btn-primary {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
            box-shadow: 0 4px 0 #3b6ba0; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ –¥–ª—è —Ç–µ–Ω–∏ */
        }

        .btn-primary:active {
            box-shadow: 0 1px 0 #3b6ba0;
            transform: translateY(3px);
        }

        /* --- –ö–Ω–æ–ø–∫–∞ "–í–∑–æ—Ä–≤–∞—Ç—å" --- */
        .blast-area {
            text-align: center;
            margin: 40px 0;
        }

        #blastButton {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            font-size: 1.8em;
            padding: 0;
            background: var(--dynamite-gradient);
            color: var(--tg-button-text);
            border: 8px solid #ff9393;
            box-shadow: 0 10px 0 #b93e32, 0 0 20px rgba(255, 107, 107, 0.7);
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        #blastButton:active {
            box-shadow: 0 4px 0 #b93e32, 0 0 15px rgba(255, 107, 107, 0.5);
            transform: translateY(6px) scale(0.98);
        }

        #blastButton span {
            font-size: 0.5em;
            color: #f7f7f7;
            margin-top: 5px;
        }

        /* --- –§–æ—Ä–º–∞ –≤—ã–≤–æ–¥–∞ --- */
        .withdraw-form input[type="number"], .withdraw-form input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--tg-hint);
            border-radius: 8px;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            box-sizing: border-box;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }

        .withdraw-form input[type="number"]:focus, .withdraw-form input[type="text"]:focus {
            border-color: var(--tg-link);
        }

        .withdraw-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--tg-hint);
            font-size: 0.9em;
        }
        
        .hint-text {
            color: var(--tg-hint);
            font-size: 0.9em;
            margin-top: 10px;
        }

        /* --- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è --- */
        .referral-share {
            display: flex;
            align-items: center;
            background-color: var(--tg-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed var(--tg-hint);
        }

        .referral-share code {
            flex-grow: 1;
            overflow-x: auto;
            white-space: nowrap;
            font-size: 0.9em;
            color: var(--tg-link);
            padding-right: 10px;
        }

        .referral-share button {
            background: none;
            border: none;
            color: var(--tg-link);
            cursor: pointer;
            padding: 5px;
            font-size: 1.2em;
        }

        .referral-share button:active {
            opacity: 0.7;
        }

        /* --- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å (–¢–∞–±—ã) --- */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--tg-secondary-bg);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: var(--tg-hint);
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            user-select: none;
        }
        
        .nav-item.active {
            color: var(--tg-link);
        }

        .nav-item i {
            font-size: 1.4em;
            margin-bottom: 3px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ (–ø—Ä–æ—Å—Ç—ã–µ SVG) */
        .icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
            margin-bottom: 3px;
        }

        /* --- –°–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ --- */
        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–∏–∑–∞—Ö */
        #prizeMessage {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            background-color: rgba(255, 215, 0, 0.1);
            color: var(--gold-color-light);
            font-weight: 600;
            transition: opacity 0.3s ease-out;
            opacity: 0;
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ-–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
        <div class="welcome-message" id="welcomeMessageEl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <!-- –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏ –±–∞–ª–∞–Ω—Å -->
        <div class="card balance-info">
            <div class="stat-item">
                <h3 id="starsBalance">0.00</h3>
                <p>–ó–≤–µ–∑–¥—ã (‚òÖ)</p>
            </div>
            <div class="stat-item">
                <h3 id="dynamiteCount">0</h3>
                <p>–î–∏–Ω–∞–º–∏—Ç (üß®)</p>
            </div>
        </div>

        <!-- --- –°–µ–∫—Ü–∏—è "–î–æ–±—ã—á–∞" (Mining) --- -->
        <div id="miningSection" class="section-content active">
            
            <div class="blast-area">
                <button id="blastButton">
                    <span style="font-size: 2em;">üß®</span>
                    –í–∑–æ—Ä–≤–∞—Ç—å
                    <span>(–°–ø–∏—à–µ—Ç—Å—è 1 –î–∏–Ω–∞–º–∏—Ç)</span>
                </button>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏–∑–µ -->
            <div id="prizeMessage"></div>

            <div class="card">
                <h2>–ß—Ç–æ –¥–∞–ª—å—à–µ?</h2>
                <p class="hint-text">–ö–∞–∂–¥—ã–π –≤–∑—Ä—ã–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 1 –µ–¥–∏–Ω–∏—Ü—É –î–∏–Ω–∞–º–∏—Ç–∞ –∏ –¥–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ó–≤–µ–∑–¥ (‚òÖ).</p>
                <p class="hint-text">–î–∏–Ω–∞–º–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –∏–ª–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É.</p>
                <button class="btn btn-primary" onclick="showSection('friendsSection', document.querySelector('.nav-item[onclick*=\"friendsSection\"]'))">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</button>
            </div>
        </div>

        <!-- --- –°–µ–∫—Ü–∏—è "–î—Ä—É–∑—å—è" (Friends/Referrals) --- -->
        <div id="friendsSection" class="section-content">
            <div class="card">
                <h2>–ú–æ–∏ –†–µ—Ñ–µ—Ä–∞–ª—ã</h2>
                <div class="balance-info" style="margin-bottom: 20px;">
                    <div class="stat-item">
                        <h3 id="friendsCount">0</h3>
                        <p>–î—Ä—É–∑–µ–π</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="referralEarnings">0.00</h3>
                        <p>–î–æ—Ö–æ–¥ (‚òÖ)</p>
                    </div>
                </div>
                
                <p class="hint-text">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å—ã –î–∏–Ω–∞–º–∏—Ç–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –∏—Ö –¥–æ–±—ã—á–∏ –ó–≤–µ–∑–¥!</p>

                <label>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</label>
                <div class="referral-share">
                    <code id="referralLinkEl">–ó–∞–≥—Ä—É–∑–∫–∞...</code>
                    <button onclick="copyReferralLink()">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M16 1h6v6l-2-2v-2h-3v-3l-2-2zm-8 0l-2 2h-2v3l-2 2h-2v-6h6zm8 16l2-2v-3l2-2h2v6h-6zm-8 0l-2 2h-2v-2l-2-2v-2h6z"/>
                            <path d="M14 9h-4v4h4v-4zm-2 2h-2v-2h2v2z"/>
                            <path d="M16 3l2 2v2l-2 2v-4l-2-2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- --- –°–µ–∫—Ü–∏—è "–í—ã–≤–æ–¥" (Withdrawal) --- -->
        <div id="withdrawSection" class="section-content">
            <div class="card withdraw-form">
                <h2>–í—ã–≤–æ–¥ –ó–≤–µ–∑–¥ (‚òÖ)</h2>
                <p class="hint-text">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 10.0 ‚òÖ. –í—ã–≤–æ–¥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.</p>
                
                <label for="withdrawAmount">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (‚òÖ)</label>
                <input type="number" id="withdrawAmount" placeholder="10.00" min="10.0" step="0.01">
                
                <label for="withdrawWallet">–í–∞—à –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ (TON/–¥—Ä—É–≥–æ–π)</label>
                <input type="text" id="withdrawWallet" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞">

                <button class="btn btn-gold" id="withdrawButton" onclick="withdraw()">
                    –í—ã–≤–µ—Å—Ç–∏
                </button>
                <p class="hint-text" id="withdrawError" style="color: #e74c3c; display: none;">–û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞.</p>
            </div>
        </div>

    </div> <!-- –ö–æ–Ω–µ—Ü .container -->


    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="showSection('miningSection', this)">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M12 2L9 6l3 4 3-4-3-4zM7 11h10l-2 5h-6l-2-5zM4 17h16l-1 4H5l-1-4z"/>
            </svg>
            –î–æ–±—ã—á–∞
        </div>
        <div class="nav-item" onclick="showSection('friendsSection', this)">
             <svg class="icon" viewBox="0 0 24 24">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.54.91 2.49 2.1 2.97 3.45V19h7v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
            –î—Ä—É–∑—å—è
        </div>
        <div class="nav-item" onclick="showSection('withdrawSection', this)">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M21 18c.55 0 1-.45 1-1V7c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h18zm-2-9H5v6h14V9zm-9 5l-4-4h8l-4 4z"/>
            </svg>
            –í—ã–≤–æ–¥
        </div>
    </div>


    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        const tg = window.Telegram.WebApp;
        // –ü—É—Å—Ç–æ–π URL, —Ç.–∫. –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω, –∫–æ—Ç–æ—Ä—ã–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è Railway
        const apiUrl = ''; 

        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è user
        const safeUser = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : {};

        const userState = {
            stars: 0.0,
            dynamite: 0,
            friendsCount: 0,
            referralEarnings: 0.0,
            user: safeUser,
            initData: tg.initData,
            botUsername: 'star_miner_bot', // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ
        };

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã UI ---
        const welcomeMessageEl = document.getElementById('welcomeMessageEl');
        const starsBalanceEl = document.getElementById('starsBalance');
        const dynamiteCountEl = document.getElementById('dynamiteCount');
        const friendsCountEl = document.getElementById('friendsCount');
        const referralEarningsEl = document.getElementById('referralEarnings');
        const referralLinkEl = document.getElementById('referralLinkEl');
        const blastButton = document.getElementById('blastButton');
        const prizeMessageEl = document.getElementById('prizeMessage');
        const withdrawAmountInput = document.getElementById('withdrawAmount');
        const withdrawWalletInput = document.getElementById('withdrawWallet');
        const withdrawButton = document.getElementById('withdrawButton');
        const withdrawErrorEl = document.getElementById('withdrawError');

        // --- –£—Ç–∏–ª–∏—Ç—ã API ---
        async function apiPost(endpoint, data = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (userState.initData) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
                headers['X-Telegram-Init-Data'] = userState.initData;
            }

            const response = await fetch(apiUrl + endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ HTTP (–Ω–∞–ø—Ä–∏–º–µ—Ä, 400 Bad Request)
                const errorMessage = result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API';
                throw new Error(errorMessage);
            }

            return result;
        }

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI ---
        function updateUI() {
            starsBalanceEl.textContent = userState.stars.toFixed(2);
            dynamiteCountEl.textContent = userState.dynamite;
            friendsCountEl.textContent = userState.friendsCount;
            referralEarningsEl.textContent = userState.referralEarnings.toFixed(2);
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π "–í–∑–æ—Ä–≤–∞—Ç—å"
            blastButton.disabled = userState.dynamite <= 0;
            blastButton.style.opacity = userState.dynamite <= 0 ? 0.5 : 1;
            blastButton.title = userState.dynamite <= 0 ? '–ù–µ—Ç –î–∏–Ω–∞–º–∏—Ç–∞ –¥–ª—è –≤–∑—Ä—ã–≤–∞!' : '–í–∑–æ—Ä–≤–∞—Ç—å!';

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π "–í—ã–≤–µ—Å—Ç–∏"
            const currentWithdrawAmount = parseFloat(withdrawAmountInput.value) || 0;
            const minWithdraw = 10.0;
            withdrawButton.disabled = currentWithdrawAmount < minWithdraw || currentWithdrawAmount > userState.stars;
            withdrawButton.style.opacity = withdrawButton.disabled ? 0.5 : 1;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ì–ª–∞–≤–Ω–æ–π –ö–Ω–æ–ø–∫–∏ Telegram
            const currentSectionId = document.querySelector('.section-content.active').id;
            if (currentSectionId === 'miningSection' && userState.dynamite > 0) {
                 tg.MainButton.setText(`–í–∑–æ—Ä–≤–∞—Ç—å (${userState.dynamite} üß®)`);
                 tg.MainButton.show();
            } else {
                 tg.MainButton.hide();
            }
        }

        // --- –õ–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ---
        function showSection(sectionId, element = null) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            } else {
                 // –ù–∞–π—Ç–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω
                 const navItem = document.querySelector(`.nav-bar .nav-item[onclick*="${sectionId}"]`);
                 if (navItem) navItem.classList.add('active');
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ì–ª–∞–≤–Ω–æ–π –ö–Ω–æ–ø–∫–∏ Telegram
            if (sectionId === 'miningSection') {
                tg.MainButton.offClick(blast); // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫–ª—é—á–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                tg.MainButton.onClick(blast);
            } 
            // –í—ã–∑—ã–≤–∞–µ–º updateUI, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ MainButton –¥–ª—è –Ω–æ–≤–æ–π —Å–µ–∫—Ü–∏–∏
            updateUI();
        }

        // --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---

        async function loadInitialData() {
            if (!userState.initData) {
                welcomeMessageEl.textContent = '–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.';
                tg.showAlert('–¢—Ä–µ–±—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Web App.');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ user –æ–±—ä–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç id
            if (!userState.user || !userState.user.id) {
                welcomeMessageEl.textContent = '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.';
                tg.showAlert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Web App.');
                return;
            }

            tg.expand();
            tg.setHeaderColor('secondary_bg_color');
            tg.enableClosingConfirmation();

            try {
                const data = await apiPost('/api/v1/data');
                
                userState.stars = data.user_data.stars;
                userState.dynamite = data.user_data.dynamite;
                userState.friendsCount = data.referrals_count;
                userState.referralEarnings = data.user_data.referral_earnings;
                userState.botUsername = data.bot_username;

                const name = userState.user.first_name || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                welcomeMessageEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${name}! –ì–æ—Ç–æ–≤ –¥–æ–±—ã–≤–∞—Ç—å –ó–≤–µ–∑–¥—ã?`;
                referralLinkEl.textContent = `https://t.me/${userState.botUsername}?start=${userState.user.id}`;
                
            } catch (error) {
                welcomeMessageEl.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`;
                console.error("Fatal Load Error:", error);
                tg.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
            } finally {
                updateUI();
                // –ù–∞–∑–Ω–∞—á–∞–µ–º MainButton –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∏–Ω–∞–º–∏—Ç
                tg.MainButton.onClick(blast);
                if (userState.dynamite > 0) {
                    tg.MainButton.setText(`–í–∑–æ—Ä–≤–∞—Ç—å (${userState.dynamite} üß®)`);
                    tg.MainButton.show();
                }
            }
        }

        async function blast() {
            if (userState.dynamite <= 0) {
                tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –î–∏–Ω–∞–º–∏—Ç–∞ –¥–ª—è –≤–∑—Ä—ã–≤–∞!');
                return;
            }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            blastButton.disabled = true;
            withdrawButton.disabled = true;
            tg.MainButton.showProgress(true);

            try {
                const data = await apiPost('/api/v1/blast');

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                userState.stars = data.new_stars;
                userState.dynamite = data.new_dynamite;
                const prize = data.prize_amount.toFixed(2);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏–∑–µ
                prizeMessageEl.textContent = `üí• –£—Å–ø–µ—Ö! –í—ã –¥–æ–±—ã–ª–∏ ${prize} ‚òÖ!`;
                prizeMessageEl.style.opacity = 1;
                setTimeout(() => {
                    prizeMessageEl.style.opacity = 0;
                }, 3000);

            } catch (error) {
                tg.showAlert(`–û—à–∏–±–∫–∞ –≤–∑—Ä—ã–≤–∞: ${error.message}`);
                console.error("Blast Error:", error);
            } finally {
                blastButton.disabled = false;
                tg.MainButton.showProgress(false);
                updateUI();
            }
        }

        async function withdraw() {
            const amount = parseFloat(withdrawAmountInput.value);
            const wallet = withdrawWalletInput.value.trim();
            const minWithdraw = 10.0;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
            if (isNaN(amount) || amount < minWithdraw) {
                withdrawErrorEl.textContent = `–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: ${minWithdraw.toFixed(2)} ‚òÖ.`;
                withdrawErrorEl.style.display = 'block';
                return;
            }
            if (amount > userState.stars) {
                withdrawErrorEl.textContent = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –í–∞—à –±–∞–ª–∞–Ω—Å: ${userState.stars.toFixed(2)} ‚òÖ.`;
                withdrawErrorEl.style.display = 'block';
                return;
            }
            if (!wallet) {
                withdrawErrorEl.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞.';
                withdrawErrorEl.style.display = 'block';
                return;
            }
            
            // –°–±—Ä–æ—Å –æ—à–∏–±–∫–∏
            withdrawErrorEl.style.display = 'none';

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
            tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏ ${amount.toFixed(2)} ‚òÖ –Ω–∞ –∞–¥—Ä–µ—Å ${wallet}?`, async (isConfirmed) => {
                if (!isConfirmed) return;

                withdrawButton.disabled = true;
                tg.showProgress(true);

                try {
                    // –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –≤–∞—à Python-–∫–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ 'amount', –∞ –Ω–µ 'wallet'. 
                    // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å Python-–∫–æ–¥, —á—Ç–æ–±—ã –æ–Ω –ø—Ä–∏–Ω–∏–º–∞–ª 'wallet'.
                    // –°–µ–π—á–∞—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ amount, –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç —Ç–µ–∫—É—â–∏–π Python-–∫–æ–¥.
                    const data = await apiPost('/api/v1/withdraw', { amount: amount }); 
                    
                    userState.stars = data.new_stars; // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
                    tg.showAlert(`‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ ${amount.toFixed(2)} ‚òÖ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω. –û–Ω –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.`);
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    withdrawAmountInput.value = '';
                    withdrawWalletInput.value = '';

                } catch (error) {
                    const errorMessage = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–≤–æ–¥.';
                    tg.showAlert(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–≤–æ–¥–∞: ${errorMessage}`);
                    console.error("Withdrawal Error:", error);
                } finally {
                    withdrawButton.disabled = false;
                    tg.showProgress(false);
                    updateUI();
                }
            });
        }
        
        // --- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI ---

        function copyReferralLink() {
            const link = referralLinkEl.textContent;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º document.execCommand('copy') –∫–∞–∫ –±–æ–ª–µ–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –≤ iFrame
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            tg.showPopup({
                title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ',
                message: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.',
                buttons: [{ text: 'OK', type: 'default' }]
            });
        }
        
        // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è
        withdrawAmountInput.addEventListener('input', updateUI);
        
        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        document.addEventListener('DOMContentLoaded', () => {
             loadInitialData();

             // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –Ω–∞ –∫–Ω–æ–ø–∫—É "–í–∑–æ—Ä–≤–∞—Ç—å" –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
             blastButton.addEventListener('click', blast);
        });

    </script>
</body>
</html>
